require 'nmap/xml'
require 'diffy'
require 'mail'
nmap_targets = 'XXXXXXXX'
scan_output_dir = '/opt/raporty/'
require 'ipaddr'

def ip_range(start_range, end_range)
  start_range = IPAddr.new(start_range)
  end_range  = IPAddr.new(end_range)
  (start_range..end_range).map(&:to_s)
end

nmap_target = ip_range("10.5.5.1", "10.5.5.15") nmap_targets = "10.5.5.1"

scan_output_dir = '/opt/raporty/nmap/'
scan_start_time = Time.now.strftime("%Y-%m-%d") scan_filename = "#{nmap_targets}.xml_#{scan_start_time}"
current_scan_report_file_path = scan_output_dir + scan_filename reference_scan_output_path = scan_output_dir + 'scan-reference-' + nmap_targets + '.xml'
mail_to = 'XXXX'
reference_scan_output_path = scan_output_dir + 'scan-reference-' + "#{nmap_targets}" + '.xml'
mail_to = 'XXXXXXXX'

def scan(nmap_targets,current_scan_report_file_path)
def scan(nmap_target,current_scan_report_file_path)
  Nmap::Program.scan do |nmap|
    nmap.targets = nmap_targets
    #skanowanie TCP 3-wayHandshake
    nmap.targets = nmap_target
    nmap.connect_scan = true
    nmap.udp_scan = false
    nmap.os_fingerprint = true
    nmap.ports=[0..655]
    nmap.scan_delay = true
    nmap.xml = current_scan_report_file_path
  end
end
def extract_data_from_report(report_file_path)
  Nmap::XML.new(report_file_path) do |xml|
    xml.each_host do |host|
      host.each_port do |port|
        p port
        report[host.ip] ||= {:open_ports => []}
        report[host.ip][:open_ports] <<  "#{port.number}/#{port.protocol}"
        report[host.ip][:open_ports] << "#{port.number}/#{port.protocol}"
        report[host.ip][:ip_id_sequence] = host.ip_id_sequence.description
      end
      report[host.ip][:os_match_linux_count] = host.os.find_all {|l| l.name.include?('Linux')}.count
      report[host.ip][:os_match_linux_count] = host.os.find_all {|l| l.name.include?('Linux')}.count
    end
  end
  return report
end

def is_scan_report_different_than_reference_report?(current_scan_report_file_path, reference_scan_output_path)
  current_report = extract_data_from_report(current_scan_report_file_path)
  reference_report = extract_data_from_report(reference_scan_output_path)
  p current_report
  p reference_report
   current_report = extract_data_from_report(current_scan_report_file_path)
   reference_report = extract_data_from_report(reference_scan_output_path)
   puts "current_report:" + "\n" "#{current_report}"
   puts "reference_report:" + "\n" "#{reference_report}"
  return current_report != reference_report end

scan(nmap_targets,current_scan_report_file_path) unless File.exist?(current_scan_report_file_path)
scan(nmap_target,current_scan_report_file_path) unless File.exist?(current_scan_report_file_path)

if(File.file?("#{reference_scan_output_path}"))
    scan(nmap_target,current_scan_report_file_path)
    is_scan_report_different_than_reference_report?(current_scan_report_file_path, reference_scan_output_path)  else
    scan(nmap_target,current_scan_report_file_path)
    File.rename("#{current_scan_report_file_path}", "#{reference_scan_output_path}")
    extract_data_from_reference_scan_output = extract_data_from_report(reference_scan_output_path)
    puts "raport from latest scan:" + "\n" "#{extract_data_from_reference_scan_output}"
 end

puts "comparing scan: #{current_scan_report_file_path} with reference report"
if is_scan_report_different_than_reference_report?(current_scan_report_file_path, reference_scan_output_path)
    report = "Please check why current state is different than accepted"
    Mail.deliver do
if is_scan_report_different_than_reference_report?(current_scan_report_file_path
else
  puts 'OK'
end
end
